Sentinel投票机制是redis高可用性的解决方案

一、机制

	由一个或多个Sentinel实例组成的Sentinel系统可以监视任意多个主服务器，以及所属的从服务器，并在被监视
的主服务器进入下线状态的时，自动将下线主服务器属下的某个从服务器升级为新的主服务器继续处理新命令请求。

	当需要故障转移的时候会在集群中选出Leader执行故障转移操作，Sentinel采用了Raft协议实现了Sentinel间选举Leader的算法。

二、实现

	Sentinel会读入用户指定的配置文件，为每个要被监视的主服务器创建相应实例结构，并创建连向这些主服务器命令连接和订阅连接
，其中命令连接是用于向主服务器发送命令请求，而订阅连接是用于接收指定的频道的消息，通过SALVEOF命令实现
	哨兵的工作原理是每个哨兵会以每秒钟 1 次的频率，向已知的主服务器和从服务器，发送一个 PING 命令。如果最后一次有效回复 PING 命令的时间，超过了配置的最大下线时间（Down-After-Milliseconds）时，默认是 30s，那么这个实例会被哨兵标记为主观下线。如果一个主服务器被标记为主观下线，那么正在监视这个主服务器的所有哨兵节点，以每秒 1 次的频率确认主服务器是否进入了主观下线的状态。如果有足够数量（quorum 配置值）的哨兵证实该主服务器为主观下线，那么这个主服务器被标记为客观下线。此时所有的哨兵会按照规则（协商）自动选出新的主节点服务器，并自动完成主服务器的自动切换功能

作者：BigJoker
链接：https://juejin.cn/post/6997944007812710414
来源：稀土掘金
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。

三、故障转移流程
	
	1、选出新的主服务器，从所属的从服务器中选出状态良好、数据完整的从服务器
		1.1、去除列表中所有处鱼下线或断线状态的从服务器，保留正常在线的从服务器
		1.2、去除列表中5s未回复过领导哨兵Sentinel命令info的从服务器，保留通信顺畅良好的从服务器
		1.3、筛选从服务器数据同步比较新的
		1.4、筛选优先级最高的从服务器，如果剩余多个，则依次按偏移量最大、运行ID最小排序筛选

	2、修改从服务器的复制目标，通过SALVEOF命令实现

	3、将旧的主服务器变成从服务器，通过SALVEOF命令实现
